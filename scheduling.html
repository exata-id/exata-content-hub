<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scheduling - Content Workflow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-gray-50">
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-purple-600">Content Workflow</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="userName" class="text-gray-700"></span>
                    <button onclick="logout()" class="text-red-600 hover:text-red-800">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="flex">
        <aside class="w-64 bg-white h-screen shadow-lg">
            <nav class="mt-8">
                <a href="dashboard.html" class="flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50">Dashboard</a>
                <a href="scripts.html" class="flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50">Script Management</a>
                <a href="production.html" class="flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50">Content Production</a>
                <a href="scheduling.html" class="flex items-center px-6 py-3 bg-purple-50 text-purple-600 border-r-4 border-purple-600">
                    <span class="font-semibold">Scheduling</span>
                </a>
                <a href="analytics.html" class="flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50">Analytics</a>
                <a href="team.html" class="flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50">Team Management</a>
            </nav>
        </aside>

        <main class="flex-1 p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Content Scheduling</h2>
                <button onclick="openScheduleModal()" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700">
                    + Schedule Content
                </button>
            </div>

            <!-- Calendar View -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Calendar View</h3>
                    <div class="flex gap-2">
                        <button onclick="previousMonth()" class="px-4 py-2 border rounded-lg hover:bg-gray-50">â€¹ Previous</button>
                        <span id="currentMonth" class="px-4 py-2 font-semibold"></span>
                        <button onclick="nextMonth()" class="px-4 py-2 border rounded-lg hover:bg-gray-50">Next â€º</button>
                    </div>
                </div>
                <div id="calendar" class="grid grid-cols-7 gap-2">
                    <!-- Calendar will be rendered here -->
                </div>
            </div>

            <!-- Upcoming Schedules -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4">Upcoming Posts</h3>
                <div id="upcomingSchedules" class="space-y-3">
                    <!-- Schedule items will be loaded here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Schedule Modal -->
    <div id="scheduleModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-lg w-full">
            <h3 class="text-2xl font-bold mb-6" id="modalTitle">Schedule Content</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Content</label>
                    <select id="selectContent" class="w-full px-4 py-2 border rounded-lg">
                        <option value="">-- Select Content --</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Platform</label>
                    <select id="platform" class="w-full px-4 py-2 border rounded-lg">
                        <option value="youtube">YouTube</option>
                        <option value="instagram">Instagram</option>
                        <option value="tiktok">TikTok</option>
                        <option value="facebook">Facebook</option>
                        <option value="twitter">Twitter/X</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                        <input type="date" id="scheduleDate" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Time</label>
                        <input type="time" id="scheduleTime" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Post Link (optional)</label>
                    <input type="url" id="postLink" placeholder="https://..." class="w-full px-4 py-2 border rounded-lg">
                    <p class="text-xs text-gray-500 mt-1">Add after posting to social media</p>
                </div>
            </div>

            <div class="flex gap-4 mt-6">
                <button onclick="saveSchedule()" class="flex-1 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700">
                    Save Schedule
                </button>
                <button onclick="closeScheduleModal()" class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script src="js/utils.js"></script>
    <script>
        checkAuth();
        let userData = JSON.parse(localStorage.getItem('user_data'));
        document.getElementById('userName').textContent = userData.name;
        
        let currentDate = new Date();
        let schedules = [];
        let editingId = null;

        async function loadSchedules() {
            try {
                const result = await apiCall('getSchedules');
                schedules = result.schedules || [];
                renderCalendar();
                renderUpcoming();
            } catch (error) {
                showError('Failed to load schedules');
            }
        }

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('currentMonth').textContent = 
                currentDate.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            let calendarHTML = '';
            
            // Day headers
            const dayNames = ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'];
            dayNames.forEach(day => {
                calendarHTML += `<div class="text-center font-semibold text-gray-600 py-2">${day}</div>`;
            });
            
            // Empty cells before first day
            for (let i = 0; i < firstDay; i++) {
                calendarHTML += '<div class="p-2 border border-gray-100"></div>';
            }
            
            // Days with schedules
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const daySchedules = schedules.filter(s => s.scheduled_date === dateStr);
                
                const currentDay = new Date(year, month, day);
                const isToday = currentDay.getTime() === today.getTime();
                const isPast = currentDay < today;
                
                calendarHTML += `
                    <div class="p-2 border border-gray-100 min-h-[100px] ${daySchedules.length > 0 ? 'bg-purple-50' : ''} ${isToday ? 'ring-2 ring-purple-600' : ''} ${isPast ? 'bg-gray-50' : ''}">
                        <div class="font-semibold text-gray-700 mb-1 ${isToday ? 'text-purple-600' : ''}">${day}</div>
                        ${daySchedules.slice(0, 3).map(s => `
                            <div class="text-xs bg-purple-600 text-white rounded px-2 py-1 mb-1 truncate cursor-pointer hover:bg-purple-700" 
                                 onclick="editSchedule('${s.id}')"
                                 title="${s.platform}: ${s.content_title} at ${s.scheduled_time}">
                                ${s.scheduled_time} ${getPlatformIcon(s.platform)}
                            </div>
                        `).join('')}
                        ${daySchedules.length > 3 ? `<div class="text-xs text-gray-500">+${daySchedules.length - 3} more</div>` : ''}
                    </div>
                `;
            }
            
            document.getElementById('calendar').innerHTML = calendarHTML;
        }

        function getPlatformIcon(platform) {
            const icons = {
                youtube: 'ðŸ“º',
                instagram: 'ðŸ“¸',
                tiktok: 'ðŸŽµ',
                facebook: 'ðŸ‘¥',
                twitter: 'ðŸ¦'
            };
            return icons[platform] || 'ðŸ“±';
        }

        function renderUpcoming() {
            const today = new Date().toISOString().split('T')[0];
            const upcoming = schedules
                .filter(s => s.scheduled_date >= today && s.status === 'scheduled')
                .sort((a, b) => {
                    const dateCompare = a.scheduled_date.localeCompare(b.scheduled_date);
                    if (dateCompare !== 0) return dateCompare;
                    return a.scheduled_time.localeCompare(b.scheduled_time);
                })
                .slice(0, 10);
            
            const container = document.getElementById('upcomingSchedules');
            
            if (upcoming.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No upcoming posts</p>';
                return;
            }
            
            container.innerHTML = upcoming.map(schedule => `
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border hover:shadow-md transition">
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-800">${escapeHtml(schedule.content_title)}</h4>
                        <p class="text-sm text-gray-600 mt-1">
                            <span class="font-medium">${getPlatformIcon(schedule.platform)} ${schedule.platform}</span> â€¢ 
                            ${formatDate(schedule.scheduled_date)} at ${schedule.scheduled_time}
                        </p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editSchedule('${schedule.id}')" 
                                class="px-3 py-1 text-sm bg-blue-100 text-blue-600 rounded hover:bg-blue-200">
                            Edit
                        </button>
                        <button onclick="markPosted('${schedule.id}')" 
                                class="px-3 py-1 text-sm bg-green-100 text-green-600 rounded hover:bg-green-200">
                            Posted
                        </button>
                        <button onclick="deleteSchedule('${schedule.id}')" 
                                class="px-3 py-1 text-sm bg-red-100 text-red-600 rounded hover:bg-red-200">
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function openScheduleModal() {
            editingId = null;
            
            showLoading('Loading content...');
            try {
                const result = await apiCall('getProduction', { status: 'completed' });
                const content = result.production || [];
                hideLoading();
                
                if (content.length === 0) {
                    showWarning('No completed content available. Please complete production first.');
                    return;
                }
                
                const select = document.getElementById('selectContent');
                select.innerHTML = '<option value="">-- Select Content --</option>';
                
                content.forEach(c => {
                    const option = document.createElement('option');
                    option.value = c.id;
                    option.textContent = c.script_title;
                    select.appendChild(option);
                });
                
                document.getElementById('modalTitle').textContent = 'Schedule Content';
                document.getElementById('scheduleDate').value = '';
                document.getElementById('scheduleTime').value = '';
                document.getElementById('postLink').value = '';
                document.getElementById('platform').value = 'youtube';
                document.getElementById('selectContent').disabled = false;
                
                document.getElementById('scheduleModal').classList.remove('hidden');
                
            } catch (error) {
                hideLoading();
                showError('Failed to load content');
            }
        }

        async function editSchedule(id) {
            const schedule = schedules.find(s => s.id === id);
            if (!schedule) return;
            
            editingId = id;
            
            const result = await apiCall('getProduction', { status: 'completed' });
            const content = result.production || [];
            
            const select = document.getElementById('selectContent');
            select.innerHTML = '<option value="">-- Select Content --</option>';
            
            content.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.script_title;
                if (c.id === schedule.content_id) option.selected = true;
                select.appendChild(option);
            });
            
            document.getElementById('modalTitle').textContent = 'Edit Schedule';
            document.getElementById('scheduleDate').value = schedule.scheduled_date;
            document.getElementById('scheduleTime').value = schedule.scheduled_time;
            document.getElementById('postLink').value = schedule.post_link || '';
            document.getElementById('platform').value = schedule.platform;
            document.getElementById('selectContent').disabled = true;
            
            document.getElementById('scheduleModal').classList.remove('hidden');
        }

        async function saveSchedule() {
            const contentId = document.getElementById('selectContent').value;
            const platform = document.getElementById('platform').value;
            const date = document.getElementById('scheduleDate').value;
            const time = document.getElementById('scheduleTime').value;
            const postLink = document.getElementById('postLink').value.trim();

            if (!editingId && !contentId) {
                showError('Please select content');
                return;
            }

            if (!date || !time) {
                showError('Please fill date and time');
                return;
            }

            // Validate date is not in the past
            const scheduleDateTime = new Date(`${date}T${time}`);
            const now = new Date();
            if (!editingId && scheduleDateTime < now) {
                showError('Cannot schedule in the past');
                return;
            }

            if (postLink && !isValidURL(postLink)) {
                showError('Please enter a valid URL for post link');
                return;
            }

            showLoading('Saving...');

            try {
                const action = editingId ? 'updateSchedule' : 'createSchedule';
                const data = { contentId, platform, date, time, postLink };
                if (editingId) data.id = editingId;

                const result = await apiCall(action, data);
                
                if (result.success) {
                    hideLoading();
                    showSuccess(editingId ? 'Schedule updated' : 'Schedule created');
                    closeScheduleModal();
                    loadSchedules();
                } else {
                    hideLoading();
                    showError(result.message || 'Failed to save schedule');
                }
            } catch (error) {
                hideLoading();
                showError('Failed to save schedule');
            }
        }

        function closeScheduleModal() {
            document.getElementById('scheduleModal').classList.add('hidden');
            editingId = null;
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        async function markPosted(id) {
            const { value: postLink } = await Swal.fire({
                title: 'Mark as Posted',
                html: `
                    <input id="swal-input-link" class="swal2-input" placeholder="Post URL (https://...)">
                `,
                showCancelButton: true,
                confirmButtonText: 'Mark as Posted',
                confirmButtonColor: '#7c3aed',
                preConfirm: () => {
                    const link = document.getElementById('swal-input-link').value;
                    if (link && !isValidURL(link)) {
                        Swal.showValidationMessage('Please enter a valid URL');
                        return false;
                    }
                    return link;
                }
            });

            if (postLink !== undefined) {
                showLoading('Updating...');
                try {
                    const result = await apiCall('updateSchedule', { 
                        id, 
                        status: 'posted', 
                        postLink: postLink || '' 
                    });
                    
                    hideLoading();
                    
                    if (result.success) {
                        showSuccess('Marked as posted');
                        loadSchedules();
                    } else {
                        showError(result.message || 'Failed to update');
                    }
                } catch (error) {
                    hideLoading();
                    showError('Failed to update schedule');
                }
            }
        }

        async function deleteSchedule(id) {
            const confirmed = await confirmAction(
                'Are you sure you want to delete this schedule?',
                'Yes, Delete'
            );
            
            if (!confirmed) return;
            
            showLoading('Deleting...');
            try {
                const result = await apiCall('deleteSchedule', { id });
                hideLoading();
                
                if (result.success) {
                    showSuccess('Schedule deleted');
                    loadSchedules();
                } else {
                    showError(result.message || 'Failed to delete');
                }
            } catch (error) {
                hideLoading();
                showError('Failed to delete schedule');
            }
        }

        // Load schedules on page load
        loadSchedules();
        
        // Auto-refresh every 60 seconds
        setInterval(loadSchedules, 60000);
    </script>
</body>
</html>
