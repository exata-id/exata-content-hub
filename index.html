<!DOCTYPE html>
<html lang="in">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Workflow Management</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- GSAP (Animasi) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <!-- Font Awesome (Ikon) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Font kustom */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Menyembunyikan scrollbar untuk main content sambil tetap bisa scroll */
        .main-content::-webkit-scrollbar {
            display: none;
        }
        .main-content {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Kelas untuk halaman aktif/non-aktif */
        .page-content {
            display: none; /* Sembunyi secara default */
        }
        .page-content.active {
            display: block; /* Tampil saat aktif */
        }
        /* Loading overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden">
        <div class="spinner"></div>
    </div>

    <!-- Halaman Login -->
    <div id="page-login" class="flex items-center justify-center min-h-screen bg-gray-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
            <h2 class="text-2xl font-bold text-center text-gray-900">Content Workflow Login</h2>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input id="email" name="email" type="email" autocomplete="email" required
                        class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit"
                    class="w-full px-4 py-2 font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">
                    Kirim Kode Login
                </button>
            </form>
        </div>
    </div>

    <!-- Wrapper Aplikasi Utama (Sidebar + Konten) -->
    <div id="app-wrapper" class="hidden">
        <div class="flex h-screen bg-gray-100">
            <!-- Sidebar -->
            <aside class="w-64 flex-shrink-0 bg-white border-r border-gray-200">
                <div class="flex flex-col h-full">
                    <!-- Sidebar Header -->
                    <div class="flex items-center justify-center h-16 border-b border-gray-200">
                        <span class="text-xl font-semibold text-blue-600">WorkflowApp</span>
                    </div>
                    <!-- Navigasi -->
                    <nav class="flex-1 px-4 py-6 space-y-2 overflow-y-auto">
                        <a href="#dashboard" data-page="page-dashboard" class="nav-link flex items-center px-4 py-2 text-gray-700 bg-gray-200 rounded-md">
                            <i class="w-5 h-5 mr-3 fas fa-tachometer-alt"></i> Dashboard
                        </a>
                        <a href="#scripts" data-page="page-scripts" class="nav-link flex items-center px-4 py-2 text-gray-700 rounded-md hover:bg-gray-100">
                            <i class="w-5 h-5 mr-3 fas fa-file-alt"></i> Script Management
                        </a>
                        <a href="#production" data-page="page-production" class="nav-link flex items-center px-4 py-2 text-gray-700 rounded-md hover:bg-gray-100">
                            <i class="w-5 h-5 mr-3 fas fa-video"></i> Content Production
                        </a>
                        <a href="#scheduling" data-page="page-scheduling" class="nav-link flex items-center px-4 py-2 text-gray-700 rounded-md hover:bg-gray-100">
                            <i class="w-5 h-5 mr-3 fas fa-calendar-alt"></i> Scheduling
                        </a>
                        <a href="#engagement" data-page="page-engagement" class="nav-link flex items-center px-4 py-2 text-gray-700 rounded-md hover:bg-gray-100">
                            <i class="w-5 h-5 mr-3 fas fa-chart-line"></i> Engagement
                        </a>
                        <a href="#analytics" data-page="page-analytics" class="nav-link flex items-center px-4 py-2 text-gray-700 rounded-md hover:bg-gray-100">
                            <i class="w-5 h-5 mr-3 fas fa-chart-pie"></i> Analytics
                        </a>
                        <a href="#team" data-page="page-team" class="nav-link flex items-center px-4 py-2 text-gray-700 rounded-md hover:bg-gray-100 admin-only">
                            <i class="w-5 h-5 mr-3 fas fa-users"></i> Team Management
                        </a>
                    </nav>
                    <!-- Sidebar Footer (User) -->
                    <div class="p-4 border-t border-gray-200">
                        <div class="flex items-center">
                            <img class="w-10 h-10 rounded-full" src="https://placehold.co/40x40/E2E8F0/A0AEC0?text=U" alt="User Avatar">
                            <div class="ml-3">
                                <p id="user-name" class="text-sm font-medium text-gray-900">Loading...</p>
                                <p id="user-role" class="text-xs text-gray-500">Loading...</p>
                            </div>
                        </div>
                        <button id="logout-button" class="w-full px-4 py-2 mt-4 text-sm font-medium text-red-700 bg-red-100 rounded-md hover:bg-red-200">
                            Logout
                        </button>
                    </div>
                </div>
            </aside>

            <!-- Konten Utama -->
            <main class="flex-1 overflow-y-auto main-content">
                <!-- Header Konten -->
                <header class="flex items-center justify-between h-16 px-6 bg-white border-b border-gray-200 sticky top-0 z-10">
                    <h1 id="page-title" class="text-xl font-semibold text-gray-900">Dashboard</h1>
                    <div class="flex items-center space-x-4">
                        <button class="p-2 text-gray-500 rounded-full hover:bg-gray-100 hover:text-gray-700">
                            <i class="fas fa-bell"></i>
                            <!-- Notifikasi (akan diisi oleh JS) -->
                        </button>
                        <button id="btn-add-new" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">
                            <i class="fas fa-plus mr-1"></i> Tambah Baru
                        </button>
                    </div>
                </header>

                <!-- Container untuk semua halaman -->
                <div class="p-6">
                    <!-- Halaman Dashboard -->
                    <section id="page-dashboard" class="page-content active">
                        <div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-4">
                            <!-- Stat Card 1 -->
                            <div class="p-6 bg-white rounded-lg shadow-md">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-500">Script Draf</p>
                                        <p id="stat-draft" class="text-3xl font-bold text-gray-900">0</p>
                                    </div>
                                    <div class="p-3 bg-blue-100 rounded-full text-blue-500">
                                        <i class="fas fa-file-alt"></i>
                                    </div>
                                </div>
                            </div>
                            <!-- Stat Card 2 -->
                            <div class="p-6 bg-white rounded-lg shadow-md">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-500">Perlu Direvisi</p>
                                        <p id="stat-revision" class="text-3xl font-bold text-gray-900">0</p>
                                    </div>
                                    <div class="p-3 bg-yellow-100 rounded-full text-yellow-500">
                                        <i class="fas fa-exclamation-triangle"></i>
                                    </div>
                                </div>
                            </div>
                            <!-- Stat Card 3 -->
                            <div class="p-6 bg-white rounded-lg shadow-md">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-500">Siap Produksi</p>
                                        <p id="stat-approved" class="text-3xl font-bold text-gray-900">0</p>
                                    </div>
                                    <div class="p-3 bg-green-100 rounded-full text-green-500">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                </div>
                            </div>
                            <!-- Stat Card 4 -->
                            <div class="p-6 bg-white rounded-lg shadow-md">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-500">Total Tayang (Bulan Ini)</p>
                                        <p id="stat-views" class="text-3xl font-bold text-gray-900">0</p>
                                    </div>
                                    <div class="p-3 bg-indigo-100 rounded-full text-indigo-500">
                                        <i class="fas fa-eye"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Aktivitas Terbaru & Task Saya -->
                        <div class="grid grid-cols-1 gap-6 mt-6 lg:grid-cols-3">
                            <div class="lg:col-span-2 p-6 bg-white rounded-lg shadow-md">
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Aktivitas Tim Terbaru</h3>
                                <div id="activity-log" class="space-y-4 max-h-96 overflow-y-auto">
                                    <!-- Log diisi oleh JS -->
                                    <p class="text-gray-500">Memuat aktivitas...</p>
                                </div>
                            </div>
                            <div class="p-6 bg-white rounded-lg shadow-md">
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Task Saya</h3>
                                <div id="my-tasks" class="space-y-3">
                                    <!-- Task diisi oleh JS -->
                                    <p class="text-gray-500">Memuat task...</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Halaman Script Management -->
                    <section id="page-scripts" class="page-content">
                        <div class="bg-white rounded-lg shadow-md">
                            <div class="p-4 border-b">
                                <h3 class="text-lg font-semibold">Semua Script</h3>
                            </div>
                            <div class="p-4">
                                <div class="flex justify-between mb-4">
                                    <input type="text" id="search-scripts" placeholder="Cari script..." class="px-3 py-2 border rounded-md">
                                    <select id="filter-scripts-status" class="px-3 py-2 border rounded-md">
                                        <option value="">Semua Status</option>
                                        <option value="Draft">Draft</option>
                                        <option value="Review">Review</option>
                                        <option value="Revision Needed">Revision Needed</option>
                                        <option value="Approved">Approved</option>
                                    </select>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Judul</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Creator</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tgl Update</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="scripts-table-body" class="bg-white divide-y divide-gray-200">
                                            <!-- Data diisi oleh JS -->
                                            <tr><td colspan="5" class="p-4 text-center text-gray-500">Memuat data...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Halaman Content Production -->
                    <section id="page-production" class="page-content">
                        <div class="bg-white rounded-lg shadow-md">
                            <div class="p-4 border-b">
                                <h3 class="text-lg font-semibold">Tracking Produksi</h3>
                            </div>
                            <div class="p-4">
                               <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Script</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status Produksi</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Editor</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Link Media</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="production-table-body" class="bg-white divide-y divide-gray-200">
                                            <!-- Data diisi oleh JS -->
                                            <tr><td colspan="5" class="p-4 text-center text-gray-500">Memuat data...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </section>
                    
                    <!-- Halaman Scheduling -->
                    <section id="page-scheduling" class="page-content">
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <h3 class="text-lg font-semibold mb-4">Kalender Konten</h3>
                            <!-- Placeholder untuk Kalender - Integrasi penuh memerlukan library seperti FullCalendar.js -->
                            <!-- Ini adalah versi sederhana -->
                            <div id="simple-calendar" class="grid grid-cols-7 gap-1">
                                <!-- Header Hari -->
                                <div class="text-center font-medium text-xs text-gray-500 uppercase">Min</div>
                                <div class="text-center font-medium text-xs text-gray-500 uppercase">Sen</div>
                                <div class="text-center font-medium text-xs text-gray-500 uppercase">Sel</div>
                                <div class="text-center font-medium text-xs text-gray-500 uppercase">Rab</div>
                                <div class="text-center font-medium text-xs text-gray-500 uppercase">Kam</div>
                                <div class="text-center font-medium text-xs text-gray-500 uppercase">Jum</div>
                                <div class="text-center font-medium text-xs text-gray-500 uppercase">Sab</div>
                                <!-- Tanggal (Di-render oleh JS) -->
                            </div>
                            <div id="schedule-list" class="mt-6">
                                <h4 class="font-semibold mb-2">Jadwal Terdekat</h4>
                                <div id="schedule-list-body" class="space-y-3">
                                    <p class="text-gray-500">Memuat jadwal...</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Halaman Engagement Tracking -->
                    <section id="page-engagement" class="page-content">
                        <div class="bg-white rounded-lg shadow-md">
                            <div class="p-4 border-b flex justify-between items-center">
                                <h3 class="text-lg font-semibold">Input Performa Konten</h3>
                                <div>
                                    <label for="csv-upload" class="cursor-pointer px-3 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700">
                                        <i class="fas fa-file-csv mr-1"></i> Upload CSV
                                    </label>
                                    <input type="file" id="csv-upload" class="hidden" accept=".csv">
                                </div>
                            </div>
                            <div class="p-4">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Konten</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tgl Posting</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Views</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Likes</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Shares</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="performance-table-body" class="bg-white divide-y divide-gray-200">
                                            <!-- Data diisi oleh JS -->
                                            <tr><td colspan="6" class="p-4 text-center text-gray-500">Memuat data...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Halaman Analytics -->
                    <section id="page-analytics" class="page-content">
                        <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
                            <div class="p-6 bg-white rounded-lg shadow-md">
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Performa per Kreator</h3>
                                <canvas id="creator-chart"></canvas>
                            </div>
                            <div class="p-6 bg-white rounded-lg shadow-md">
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Views Bulanan</h3>
                                <canvas id="monthly-chart"></canvas>
                            </div>
                        </div>
                    </section>

                    <!-- Halaman Team Management (Admin Only) -->
                    <section id="page-team" class="page-content">
                         <div class="bg-white rounded-lg shadow-md">
                            <div class="p-4 border-b">
                                <h3 class="text-lg font-semibold">Manajemen Anggota Tim</h3>
                            </div>
                            <div class="p-4">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="team-table-body" class="bg-white divide-y divide-gray-200">
                                            <!-- Data diisi oleh JS -->
                                            <tr><td colspan="4" class="p-4 text-center text-gray-500">Memuat data...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </section>

                </div>
            </main>
        </div>
    </div>

    <script>
        // ========================================================================
        // KONFIGURASI APLIKASI
        // ========================================================================
        // !!! PENTING: Ganti dengan URL Web App Anda setelah deploy Apps Script
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzE3rmLTP7mqFiPDEx0fCwgUDkcwXoMcWuzfGHyLComF5KRCTVLTza4Z8mHrSZGua22_w/exec'; 

        // ========================================================================
        // STATE APLIKASI
        // ========================================================================
        let currentUser = null;
        let activePage = 'page-dashboard';
        let charts = {}; // Untuk menyimpan instance Chart.js
        let localDataCache = {
            scripts: [],
            production: [],
            schedules: [],
            performance: [],
            team: [],
            logs: []
        };

        // ========================================================================
        // ELEMEN DOM
        // ========================================================================
        const pageLogin = document.getElementById('page-login');
        const appWrapper = document.getElementById('app-wrapper');
        const loginForm = document.getElementById('login-form');
        const logoutButton = document.getElementById('logout-button');
        const loadingOverlay = document.getElementById('loading-overlay');
        const navLinks = document.querySelectorAll('.nav-link');
        const pageTitle = document.getElementById('page-title');
        const btnAddNew = document.getElementById('btn-add-new');
        const userNameEl = document.getElementById('user-name');
        const userRoleEl = document.getElementById('user-role');
        const adminOnlyLinks = document.querySelectorAll('.admin-only');

        // ========================================================================
        // FUNGSI UTILITY & API
        // ========================================================================

        /**
         * Menampilkan atau menyembunyikan overlay loading
         * @param {boolean} show - True untuk menampilkan, false untuk menyembunyikan
         */
        function showLoading(show) {
            if (show) {
                loadingOverlay.classList.remove('hidden');
                gsap.to(loadingOverlay, { opacity: 1, duration: 0.3 });
            } else {
                gsap.to(loadingOverlay, { 
                    opacity: 0, 
                    duration: 0.3, 
                    onComplete: () => loadingOverlay.classList.add('hidden') 
                });
            }
        }

        /**
         * Wrapper untuk fetch ke Google Apps Script
         * @param {string} action - Nama fungsi di Apps Script
         * @param {object} payload - Data yang dikirim
         * @returns {Promise<object>} - Respon JSON dari Apps Script
         */
        async function fetchApi(action, payload = {}) {
            showLoading(true);
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ action, payload, user: currentUser }),
                    redirect: 'follow'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.status === 'error') {
                    throw new Error(result.message);
                }
                
                return result.data;

            } catch (error) {
                console.error('API Error:', action, error);
                Swal.fire({
                    icon: 'error',
                    title: 'Oops... Terjadi Kesalahan',
                    text: error.message || 'Gagal terhubung ke server. Silakan coba lagi.',
                });
                return null; // Mengembalikan null agar pemanggil bisa menangani
            } finally {
                showLoading(false);
            }
        }

        /**
         * Menampilkan notifikasi toast
         * @param {string} title - Judul notifikasi
         * @param {string} icon - 'success', 'error', 'warning', 'info'
         */
        function showToast(title, icon = 'success') {
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: icon,
                title: title,
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
            });
        }

        // ========================================================================
        // FUNGSI AUTENTIKASI
        // ========================================================================

        /**
         * Memeriksa status login saat aplikasi dimuat
         */
        function checkLoginState() {
            const storedUser = localStorage.getItem('contentUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
                showAppWrapper();
                loadDashboardData();
            } else {
                showLoginPage();
            }
            gsap.from('body', { opacity: 0, duration: 0.5 });
        }

        /**
         * Menampilkan halaman login
         */
        function showLoginPage() {
            pageLogin.classList.remove('hidden');
            appWrapper.classList.add('hidden');
            gsap.from(pageLogin, { opacity: 0, y: 20, duration: 0.5 });
        }

        /**
         * Menampilkan aplikasi utama setelah login berhasil
         */
        function showAppWrapper() {
            userNameEl.textContent = currentUser.name;
            userRoleEl.textContent = currentUser.role;

            // Atur visibilitas berdasarkan role
            if (currentUser.role === 'Admin') {
                adminOnlyLinks.forEach(link => link.classList.remove('hidden'));
            } else {
                adminOnlyLinks.forEach(link => link.classList.add('hidden'));
            }
            
            pageLogin.classList.add('hidden');
            appWrapper.classList.remove('hidden');
            gsap.from(appWrapper, { opacity: 0, duration: 0.5 });
            
            // Set halaman default
            navigateTo('page-dashboard');
        }

        /**
         * Menangani submit form login (mengirim email)
         */
        async function handleLoginSubmit(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            if (!email) return;

            const data = await fetchApi('sendLoginCode', { email });
            
            if (data && data.status === 'success') {
                // Tampilkan modal SweetAlert untuk memasukkan kode
                const { value: code } = await Swal.fire({
                    title: 'Verifikasi Kode',
                    text: `Kami telah mengirimkan kode ke ${email}. Silakan cek email Anda.`,
                    input: 'text',
                    inputLabel: 'Kode Verifikasi',
                    inputPlaceholder: 'Masukkan 6 digit kode',
                    inputAttributes: {
                        maxlength: 6,
                        autocapitalize: 'off',
                        autocorrect: 'off'
                    },
                    showCancelButton: true,
                    confirmButtonText: 'Verifikasi',
                    showLoaderOnConfirm: true,
                    preConfirm: (inputCode) => {
                        return verifyLoginCode(email, inputCode);
                    },
                    allowOutsideClick: () => !Swal.isLoading()
                });

                if (code) {
                    Swal.fire({
                        title: `Selamat Datang, ${code.name}!`,
                        text: 'Login berhasil.',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }
            }
        }

        /**
         * Memverifikasi kode login ke Apps Script
         */
        async function verifyLoginCode(email, code) {
            const data = await fetchApi('verifyCodeAndGetUser', { email, code });

            if (data && data.status === 'success') {
                currentUser = data.user;
                // Simpan ke cache (localStorage)
                localStorage.setItem('contentUser', JSON.stringify(currentUser));
                showAppWrapper();
                loadDashboardData();
                return data.user;
            } else {
                Swal.showValidationMessage(data ? data.message : 'Verifikasi gagal');
                return null;
            }
        }

        /**
         * Menangani logout
         */
        function handleLogout() {
            localStorage.removeItem('contentUser');
            currentUser = null;
            showLoginPage();
            showToast('Anda telah logout', 'info');
        }

        // ========================================================================
        // FUNGSI NAVIGASI
        // ========================================================================
        
        /**
         * Berpindah ke halaman yang dituju
         * @param {string} pageId - ID elemen section halaman
         */
        function navigateTo(pageId) {
            // Sembunyikan semua halaman
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active');
            });

            // Tampilkan halaman yang dituju
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
                gsap.from(targetPage, { opacity: 0, y: 10, duration: 0.4 });
                
                // Update judul halaman
                const navLink = document.querySelector(`.nav-link[data-page="${pageId}"]`);
                pageTitle.textContent = navLink ? navLink.textContent.trim() : 'Dashboard';
                activePage = pageId;
                
                // Update highlight navlink
                navLinks.forEach(link => {
                    link.classList.remove('bg-gray-200');
                    if(link.dataset.page === pageId) {
                        link.classList.add('bg-gray-200');
                    }
                });

                // Memuat data yang relevan untuk halaman tersebut
                loadPageData(pageId);
                // Update tombol "Tambah Baru"
                updateAddNewButton(pageId);
            }
        }
        
        /**
         * Memuat data berdasarkan halaman yang aktif
         * @param {string} pageId - ID halaman
         */
        function loadPageData(pageId) {
            switch(pageId) {
                case 'page-dashboard':
                    loadDashboardData();
                    break;
                case 'page-scripts':
                    loadScriptsData();
                    break;
                case 'page-production':
                    loadProductionData();
                    break;
                case 'page-scheduling':
                    loadSchedulingData();
                    break;
                case 'page-engagement':
                    loadPerformanceData();
                    break;
                case 'page-analytics':
                    loadAnalyticsData();
                    break;
                case 'page-team':
                    if (currentUser.role === 'Admin') loadTeamData();
                    break;
            }
        }

        /**
         * Mengatur fungsi tombol "Tambah Baru" berdasarkan halaman
         * @param {string} pageId - ID halaman
         */
        function updateAddNewButton(pageId) {
            // Hapus event listener lama
            const newBtn = btnAddNew.cloneNode(true);
            btnAddNew.parentNode.replaceChild(newBtn, btnAddNew);
            btnAddNew = newBtn; // Update referensi
            
            btnAddNew.classList.remove('hidden'); // Tampilkan secara default

            switch(pageId) {
                case 'page-scripts':
                    btnAddNew.textContent = 'Tambah Script Baru';
                    btnAddNew.onclick = showAddScriptModal;
                    break;
                case 'page-scheduling':
                    btnAddNew.textContent = 'Buat Jadwal Baru';
                    btnAddNew.onclick = showAddScheduleModal;
                    break;
                case 'page-engagement':
                    btnAddNew.textContent = 'Input Performa';
                    btnAddNew.onclick = showAddPerformanceModal;
                    break;
                case 'page-team':
                    btnAddNew.textContent = 'Tambah Anggota Tim';
                    btnAddNew.onclick = showAddTeamMemberModal;
                    break;
                default:
                    btnAddNew.classList.add('hidden'); // Sembunyikan di halaman lain
            }
        }

        // ========================================================================
        // FUNGSI LOAD DATA PER HALAMAN
        // ========================================================================
        
        async function loadDashboardData() {
            const data = await fetchApi('getDashboardStats');
            if (!data) return;

            // Update Stat Cards
            document.getElementById('stat-draft').textContent = data.stats.draft || 0;
            document.getElementById('stat-revision').textContent = data.stats.revision || 0;
            document.getElementById('stat-approved').textContent = data.stats.approved || 0;
            document.getElementById('stat-views').textContent = data.stats.views ? Number(data.stats.views).toLocaleString('id-ID') : 0;
            
            // Update Activity Log
            const activityLogEl = document.getElementById('activity-log');
            activityLogEl.innerHTML = '';
            if (data.logs.length > 0) {
                data.logs.forEach(log => {
                    const logEl = document.createElement('div');
                    logEl.className = 'flex items-center text-sm';
                    logEl.innerHTML = `
                        <div class="p-2 bg-gray-100 rounded-full mr-3"><i class="fas fa-info-circle text-gray-500"></i></div>
                        <div>
                            <p class="text-gray-800">${log.message}</p>
                            <p class="text-xs text-gray-500">${new Date(log.timestamp).toLocaleString('id-ID')} oleh ${log.user}</p>
                        </div>
                    `;
                    activityLogEl.appendChild(logEl);
                });
            } else {
                activityLogEl.innerHTML = '<p class="text-gray-500">Belum ada aktivitas.</p>';
            }

            // Update My Tasks (Contoh: script yang perlu direvisi)
            const myTasksEl = document.getElementById('my-tasks');
            myTasksEl.innerHTML = '';
            const myTasks = data.tasks.filter(task => (task.creator === currentUser.email && task.status === 'Revision Needed') || (task.editor === currentUser.email && task.status_produksi === 'In Progress'));
            
            if (myTasks.length > 0) {
                myTasks.forEach(task => {
                    const taskEl = document.createElement('div');
                    taskEl.className = 'p-3 bg-yellow-50 rounded-md border border-yellow-200';
                    taskEl.innerHTML = `
                        <p class="font-medium text-yellow-800">${task.judul || 'Task Produksi'}</p>
                        <p class="text-sm text-yellow-700">${task.status === 'Revision Needed' ? 'Script perlu revisi' : `Produksi: ${task.status_produksi}`}</p>
                    `;
                    myTasksEl.appendChild(taskEl);
                });
            } else {
                myTasksEl.innerHTML = '<p class="text-gray-500">Tidak ada task mendesak.</p>';
            }
        }
        
        async function loadScriptsData() {
            const data = await fetchApi('getScripts');
            if (!data) return;
            localDataCache.scripts = data; // Simpan di cache
            renderScriptsTable(data);
        }

        async function loadProductionData() {
            const data = await fetchApi('getProductionTasks');
            if (!data) return;
            localDataCache.production = data;
            renderProductionTable(data);
        }

        async function loadSchedulingData() {
            const data = await fetchApi('getSchedules');
            if (!data) return;
            localDataCache.schedules = data;
            renderScheduleList(data);
            // renderSimpleCalendar(data); // (Implementasi kalender)
        }

        async function loadPerformanceData() {
            const data = await fetchApi('getPerformanceData');
            if (!data) return;
            localDataCache.performance = data;
            renderPerformanceTable(data);
        }

        async function loadAnalyticsData() {
            const data = await fetchApi('getAnalyticsData');
            if (!data) return;
            renderAnalyticsCharts(data);
        }
        
        async function loadTeamData() {
            const data = await fetchApi('getTeamMembers');
            if (!data) return;
            localDataCache.team = data;
            renderTeamTable(data);
        }

        // ========================================================================
        // FUNGSI RENDER DATA KE TABEL
        // ========================================================================

        function renderScriptsTable(data) {
            const tbody = document.getElementById('scripts-table-body');
            tbody.innerHTML = '';
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">Belum ada script.</td></tr>';
                return;
            }
            data.forEach(script => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${script.judul}</div>
                        <div class="text-sm text-gray-500">${script.id}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${script.creator_name}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(script.status)}">
                            ${script.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${new Date(script.last_update).toLocaleDateString('id-ID')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="showEditScriptModal('${script.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteScript('${script.id}')" class="text-red-600 hover:text-red-900 ${currentUser.role !== 'Admin' ? 'hidden' : ''}"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function renderProductionTable(data) {
            const tbody = document.getElementById('production-table-body');
            tbody.innerHTML = '';
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">Belum ada data produksi.</td></tr>';
                return;
            }
            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.script_judul}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                         <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(item.status_produksi)}">
                            ${item.status_produksi}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${item.editor_name || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        ${item.link_media ? `<a href="${item.link_media}" target="_blank" class="text-blue-600 hover:underline">Lihat Media</a>` : '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="showEditProductionModal('${item.id}')" class="text-indigo-600 hover:text-indigo-900"><i class="fas fa-edit"></i> Edit</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function renderScheduleList(data) {
            const listBody = document.getElementById('schedule-list-body');
            listBody.innerHTML = '';
            if (data.length === 0) {
                listBody.innerHTML = '<p class="text-gray-500">Belum ada jadwal.</p>';
                return;
            }
            data.sort((a,b) => new Date(a.tgl_posting) - new Date(b.tgl_posting)); // Urutkan
            
            data.forEach(item => {
                const div = document.createElement('div');
                div.className = 'p-3 bg-gray-50 rounded-md border flex justify-between items-center';
                div.innerHTML = `
                    <div>
                        <p class="font-medium text-gray-900">${item.script_judul}</p>
                        <p class="text-sm text-gray-600">Platform: ${item.platform} | ${new Date(item.tgl_posting).toLocaleString('id-ID')}</p>
                    </div>
                    <button onclick="deleteSchedule('${item.id}')" class="text-red-500 hover:text-red-700 ${currentUser.role !== 'Admin' ? 'hidden' : ''}"><i class="fas fa-trash"></i></button>
                `;
                listBody.appendChild(div);
            });
        }
        
        function renderPerformanceTable(data) {
            const tbody = document.getElementById('performance-table-body');
            tbody.innerHTML = '';
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">Belum ada data performa.</td></tr>';
                return;
            }
            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.script_judul}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${new Date(item.tgl_posting).toLocaleDateString('id-ID')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${Number(item.views).toLocaleString('id-ID')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${Number(item.likes).toLocaleString('id-ID')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${Number(item.shares).toLocaleString('id-ID')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="showAddPerformanceModal('${item.id}')" class="text-indigo-600 hover:text-indigo-900"><i class="fas fa-edit"></i> Edit</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function renderTeamTable(data) {
            const tbody = document.getElementById('team-table-body');
            tbody.innerHTML = '';
            data.forEach(member => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${member.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${member.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${member.role}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="showAddTeamMemberModal('${member.email}')" class="text-indigo-600 hover:text-indigo-900 mr-3"><i class="fas fa-edit"></i></button>
                        ${currentUser.email !== member.email ? `<button onclick="deleteTeamMember('${member.email}')" class="text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button>` : ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        /**
         * Helper untuk warna status
         * @param {string} status - Teks status
         * @returns {string} - Kelas Tailwind
         */
        function getStatusColor(status) {
            switch (status) {
                case 'Draft': return 'bg-gray-100 text-gray-800';
                case 'Review': return 'bg-blue-100 text-blue-800';
                case 'Revision Needed': return 'bg-yellow-100 text-yellow-800';
                case 'Approved': return 'bg-green-100 text-green-800';
                case 'In Progress': return 'bg-indigo-100 text-indigo-800';
                case 'Completed': return 'bg-green-100 text-green-800';
                case 'Posted': return 'bg-purple-100 text-purple-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // ========================================================================
        // FUNGSI MODAL (CREATE/UPDATE)
        // ========================================================================
        
        // --- SCRIPT MODALS ---
        async function showAddScriptModal() {
            Swal.fire({
                title: 'Tambah Script Baru',
                html: `
                    <input id="swal-judul" class="swal2-input" placeholder="Judul Script">
                    <textarea id="swal-deskripsi" class="swal2-textarea" placeholder="Deskripsi singkat..."></textarea>
                    <input id="swal-link-script" class="swal2-input" placeholder="Link Google Docs Script">
                `,
                confirmButtonText: 'Simpan Draf',
                focusConfirm: false,
                preConfirm: () => {
                    return {
                        judul: document.getElementById('swal-judul').value,
                        deskripsi: document.getElementById('swal-deskripsi').value,
                        link_script: document.getElementById('swal-link-script').value,
                    }
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const payload = { ...result.value, creator_email: currentUser.email, creator_name: currentUser.name };
                    const data = await fetchApi('addScript', payload);
                    if (data) {
                        showToast('Script berhasil ditambahkan');
                        loadScriptsData(); // Refresh data
                        loadDashboardData(); // Refresh dashboard
                    }
                }
            });
        }

        async function showEditScriptModal(scriptId) {
            const script = localDataCache.scripts.find(s => s.id === scriptId);
            if (!script) return;
            
            // Hanya Admin, atau creator asli yang bisa edit detail.
            // Role lain (misal Editor) hanya bisa ubah status.
            const canEditDetails = currentUser.role === 'Admin' || currentUser.email === script.creator;

            Swal.fire({
                title: 'Edit Script',
                html: `
                    <input id="swal-judul" class="swal2-input" placeholder="Judul Script" value="${script.judul}" ${!canEditDetails ? 'disabled' : ''}>
                    <textarea id="swal-deskripsi" class="swal2-textarea" placeholder="Deskripsi singkat...">${script.deskripsi}</textarea>
                    <input id="swal-link-script" class="swal2-input" placeholder="Link Google Docs Script" value="${script.link_script}" ${!canEditDetails ? 'disabled' : ''}>
                    <select id="swal-status" class="swal2-select">
                        <option value="Draft" ${script.status === 'Draft' ? 'selected' : ''}>Draft</option>
                        <option value="Review" ${script.status === 'Review' ? 'selected' : ''}>Kirim untuk Review</option>
                        <option value="Revision Needed" ${script.status === 'Revision Needed' ? 'selected' : ''}>Perlu Revisi</option>
                        <option value="Approved" ${script.status === 'Approved' ? 'selected' : ''}>Setujui (Approved)</option>
                    </select>
                `,
                confirmButtonText: 'Update',
                focusConfirm: false,
                preConfirm: () => {
                    return {
                        id: scriptId,
                        judul: document.getElementById('swal-judul').value,
                        deskripsi: document.getElementById('swal-deskripsi').value,
                        link_script: document.getElementById('swal-link-script').value,
                        status: document.getElementById('swal-status').value
                    }
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const data = await fetchApi('updateScript', result.value);
                    if (data) {
                        showToast('Script berhasil diupdate');
                        loadScriptsData();
                        loadDashboardData();
                    }
                }
            });
        }

        async function deleteScript(scriptId) {
            Swal.fire({
                title: 'Anda yakin?',
                text: "Script akan dihapus permanen!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ya, hapus!',
                cancelButtonText: 'Batal'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const data = await fetchApi('deleteScript', { id: scriptId });
                    if (data) {
                        showToast('Script berhasil dihapus');
                        loadScriptsData();
                        loadDashboardData();
                    }
                }
            });
        }
        
        // --- PRODUCTION MODAL ---
        async function showEditProductionModal(taskId) {
            const task = localDataCache.production.find(t => t.id === taskId);
            if (!task) return;
            
            const teamOptions = localDataCache.team.filter(t => t.role === 'Editor' || t.role === 'Admin')
                                    .map(t => `<option value="${t.email}" ${task.editor === t.email ? 'selected' : ''}>${t.name}</option>`)
                                    .join('');

            Swal.fire({
                title: 'Update Status Produksi',
                html: `
                    <h4 class="text-lg font-semibold mb-2">${task.script_judul}</h4>
                    <select id="swal-prod-status" class="swal2-select">
                        <option value="Waiting" ${task.status_produksi === 'Waiting' ? 'selected' : ''}>Waiting</option>
                        <option value="In Progress" ${task.status_produksi === 'In Progress' ? 'selected' : ''}>In Progress</option>
                        <option value="Review" ${task.status_produksi === 'Review' ? 'selected' : ''}>Review</option>
                        <option value="Completed" ${task.status_produksi === 'Completed' ? 'selected' : ''}>Completed</option>
                    </select>
                    <select id="swal-editor" class="swal2-select">
                        <option value="">Pilih Editor</option>
                        ${teamOptions}
                    </select>
                    <input id="swal-link-media" class="swal2-input" placeholder="Link Media (Google Drive, dll)" value="${task.link_media || ''}">
                    <textarea id="swal-notes" class="swal2-textarea" placeholder="Catatan Editor...">${task.catatan || ''}</textarea>
                `,
                confirmButtonText: 'Update',
                focusConfirm: false,
                preConfirm: () => {
                    return {
                        id: taskId,
                        status_produksi: document.getElementById('swal-prod-status').value,
                        editor: document.getElementById('swal-editor').value,
                        link_media: document.getElementById('swal-link-media').value,
                        catatan: document.getElementById('swal-notes').value
                    }
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const data = await fetchApi('updateProductionTask', result.value);
                    if (data) {
                        showToast('Status produksi diupdate');
                        loadProductionData();
                    }
                }
            });
        }
        
        // --- SCHEDULE MODAL ---
        async function showAddScheduleModal() {
            // Ambil script yang sudah 'Completed' tapi belum dijadwal
            const productionCompleted = localDataCache.production.filter(p => p.status_produksi === 'Completed');
            const scheduledIds = localDataCache.schedules.map(s => s.production_id);
            const options = productionCompleted
                                .filter(p => !scheduledIds.includes(p.id))
                                .map(p => `<option value="${p.id}">${p.script_judul}</option>`)
                                .join('');

            if (options.length === 0) {
                showToast('Tidak ada konten yang siap dijadwal', 'info');
                return;
            }

            Swal.fire({
                title: 'Buat Jadwal Posting',
                html: `
                    <select id="swal-prod-id" class="swal2-select">
                        <option value="">Pilih Konten</option>
                        ${options}
                    </select>
                    <input id="swal-tgl-posting" class="swal2-input" type="datetime-local">
                    <select id="swal-platform" class="swal2-select">
                        <option value="YouTube">YouTube</option>
                        <option value="TikTok">TikTok</option>
                        <option value="Instagram">Instagram</option>
                        <option value="Lainnya">Lainnya</option>
                    </select>
                `,
                confirmButtonText: 'Jadwalkan',
                focusConfirm: false,
                preConfirm: () => {
                    return {
                        production_id: document.getElementById('swal-prod-id').value,
                        tgl_posting: document.getElementById('swal-tgl-posting').value,
                        platform: document.getElementById('swal-platform').value
                    }
                }
            }).then(async (result) => {
                if (result.isConfirmed && result.value.production_id && result.value.tgl_posting) {
                    const data = await fetchApi('addSchedule', result.value);
                    if (data) {
                        showToast('Konten berhasil dijadwalkan');
                        loadSchedulingData();
                    }
                }
            });
        }
        
        // ... (Fungsi deleteSchedule)
        
        // --- PERFORMANCE MODAL ---
        async function showAddPerformanceModal(performanceId = null) {
            let item = { script_judul: '', tgl_posting: '', views: '', likes: '', shares: '', comments: '' };
            let title = 'Input Performa Baru';
            let schedule_id = '';

            if (performanceId) {
                // Mode Edit
                item = localDataCache.performance.find(p => p.id === performanceId);
                title = 'Edit Performa';
            }
            
            // Opsi: Ambil dari jadwal yang sudah posting tapi belum ada data performa
            const postedSchedules = localDataCache.schedules.filter(s => new Date(s.tgl_posting) <= new Date());
            const performanceIds = localDataCache.performance.map(p => p.schedule_id);
            const scheduleOptions = postedSchedules
                                .filter(s => !performanceIds.includes(s.id))
                                .map(s => `<option value="${s.id}">${s.script_judul} @ ${s.platform}</option>`)
                                .join('');

            Swal.fire({
                title: title,
                html: `
                    <select id="swal-schedule-id" class="swal2-select" ${performanceId ? 'disabled' : ''}>
                        <option value="">Pilih Konten yang Sudah Tayang</option>
                        ${scheduleOptions}
                        ${performanceId ? `<option value="${item.schedule_id}" selected>${item.script_judul}</option>` : ''}
                    </select>
                    <input id="swal-views" class="swal2-input" type="number" placeholder="Views" value="${item.views}">
                    <input id="swal-likes" class="swal2-input" type="number" placeholder="Likes" value="${item.likes}">
                    <input id="swal-shares" class="swal2-input" type="number" placeholder="Shares" value="${item.shares}">
                    <input id="swal-comments" class="swal2-input" type="number" placeholder="Comments" value="${item.comments}">
                `,
                confirmButtonText: 'Simpan',
                focusConfirm: false,
                preConfirm: () => {
                    return {
                        id: performanceId, // Null jika baru
                        schedule_id: document.getElementById('swal-schedule-id').value,
                        views: document.getElementById('swal-views').value,
                        likes: document.getElementById('swal-likes').value,
                        shares: document.getElementById('swal-shares').value,
                        comments: document.getElementById('swal-comments').value,
                    }
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const action = performanceId ? 'updatePerformance' : 'addPerformance';
                    const data = await fetchApi(action, result.value);
                    if (data) {
                        showToast('Data performa disimpan');
                        loadPerformanceData();
                        loadDashboardData();
                    }
                }
            });
        }
        
        // --- TEAM MODAL (Admin) ---
        async function showAddTeamMemberModal(email = null) {
            let member = { name: '', email: '', role: 'Creator' };
            let title = 'Tambah Anggota Tim';
            let isEdit = false;
            
            if(email) {
                member = localDataCache.team.find(m => m.email === email);
                title = 'Edit Anggota Tim';
                isEdit = true;
            }
            
            Swal.fire({
                title: title,
                html: `
                    <input id="swal-name" class="swal2-input" placeholder="Nama Lengkap" value="${member.name}">
                    <input id="swal-email" class="swal2-input" type="email" placeholder="Email" value="${member.email}" ${isEdit ? 'disabled' : ''}>
                    <select id="swal-role" class="swal2-select">
                        <option value="Creator" ${member.role === 'Creator' ? 'selected' : ''}>Creator</option>
                        <option value="Editor" ${member.role === 'Editor' ? 'selected' : ''}>Editor</option>
                        <option value="Admin" ${member.role === 'Admin' ? 'selected' : ''}>Admin</option>
                    </select>
                `,
                confirmButtonText: 'Simpan',
                focusConfirm: false,
                preConfirm: () => {
                    return {
                        name: document.getElementById('swal-name').value,
                        email: document.getElementById('swal-email').value,
                        role: document.getElementById('swal-role').value
                    }
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const action = isEdit ? 'updateTeamMember' : 'addTeamMember';
                    const data = await fetchApi(action, result.value);
                    if (data) {
                        showToast('Anggota tim disimpan');
                        loadTeamData();
                    }
                }
            });
        }
        
        async function deleteTeamMember(email) {
             Swal.fire({
                title: 'Anda yakin?',
                text: "Anggota tim akan dihapus!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ya, hapus!',
                cancelButtonText: 'Batal'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const data = await fetchApi('deleteTeamMember', { email });
                    if (data) {
                        showToast('Anggota tim dihapus');
                        loadTeamData();
                    }
                }
            });
        }

        // ========================================================================
        // FUNGSI ANALYTICS (CHART.JS)
        // ========================================================================
        
        function renderAnalyticsCharts(data) {
            // Data Performa per Kreator
            const creatorCtx = document.getElementById('creator-chart').getContext('2d');
            if (charts.creator) charts.creator.destroy(); // Hancurkan chart lama
            charts.creator = new Chart(creatorCtx, {
                type: 'bar',
                data: {
                    labels: data.creatorStats.labels,
                    datasets: [{
                        label: 'Total Views',
                        data: data.creatorStats.data,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } }
                }
            });

            // Data Views Bulanan
            const monthlyCtx = document.getElementById('monthly-chart').getContext('2d');
            if (charts.monthly) charts.monthly.destroy(); // Hancurkan chart lama
            charts.monthly = new Chart(monthlyCtx, {
                type: 'line',
                data: {
                    labels: data.monthlyStats.labels,
                    datasets: [{
                        label: 'Total Views',
                        data: data.monthlyStats.data,
                        fill: false,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                 options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // ========================================================================
        // EVENT LISTENERS
        // ========================================================================
        
        document.addEventListener('DOMContentLoaded', () => {
            // Cek status login saat memuat
            checkLoginState();

            // Listener form login
            if (loginForm) {
                loginForm.addEventListener('submit', handleLoginSubmit);
            }

            // Listener tombol logout
            if (logoutButton) {
                logoutButton.addEventListener('click', handleLogout);
            }

            // Listener link navigasi
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = e.currentTarget.dataset.page;
                    navigateTo(pageId);
                });
            });
            
            // Listener untuk upload CSV
            const csvUpload = document.getElementById('csv-upload');
            if(csvUpload) {
                csvUpload.addEventListener('change', handleCsvUpload);
            }
        });
        
        
        // ========================================================================
        // FUNGSI TAMBAHAN (CSV UPLOAD)
        // ========================================================================
        
        function handleCsvUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                const text = e.target.result;
                // Kirim teks CSV ke Apps Script untuk diproses
                const data = await fetchApi('importPerformanceCSV', { csvData: text });
                if (data) {
                    showToast('Data CSV berhasil diimpor');
                    loadPerformanceData();
                    loadDashboardData();
                }
            };
            reader.readAsText(file);
            // Reset input file agar bisa upload file yang sama lagi
            event.target.value = null;
        }

    </script>
</body>
</html>
